<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Modérateur - Prisonnier</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root { 
  --bg: #0f0f1a; --card: rgba(255,255,255,0.95); --accent: #4a90e2; --text: #0f0f1a; 
  --green: #2ecc71; --red: #e74c3c; --orange: #f39c12; 
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  background: url('image.jpg') center center / cover no-repeat fixed;
  color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 2rem;
  display: flex; flex-direction: column; gap: 2rem; min-height: 100vh; position: relative;
}
body::before {
  content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
  background: rgba(15,15,26,0.4); z-index: -1;
}
.card { 
  background: var(--card); border-radius:16px; padding:2rem; box-shadow:0 8px 32px rgba(0,0,0,0.4);
  max-width:900px; margin:0 auto; border:1px solid rgba(74,144,226,0.2); z-index:1;
}
h1 { text-align:center; margin-bottom:1rem; }
select, button { width:100%; padding:0.9rem; border-radius:8px; border:none; margin-bottom:1rem; font-size:1rem;}
select { background:#333; color:white; }
button { background: var(--accent); color:white; font-weight:bold; cursor:pointer; transition:0.2s;}
button:hover:not(:disabled){ background:#357abd; transform:scale(1.02);}
button:disabled{ opacity:0.5; cursor:not-allowed; }
button.roundBtn{ background: var(--green); font-size:1.2rem; padding:1.2rem; margin-top:1.5rem; }
.score-table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:1rem;}
.score-table th, .score-table td{ padding:0.8rem; text-align:center; border-bottom:1px solid #444;}
.score-table th { background:#222; }
.live { color: var(--green); font-weight:bold; }
.waiting { color: var(--orange); font-weight:bold; text-align:center; margin-top:0.5rem; }
.btn-group { display:flex; gap:1rem; margin-top:1rem; justify-content:center; }
.btn-group button{ flex:1; max-width:200px; }
.btn-group button.reset { background: var(--red); }
.chart-container{ background: rgba(26,26,46,0.95); border-radius:12px; padding:1rem; backdrop-filter:blur(10px); border:1px solid rgba(74,144,226,0.2); height:380px; margin-top:1.5rem;}
</style>
</head>
<body>

<div class="card">
<h1>Scores en Direct <span class="live">Live</span></h1>
<p style="text-align:center;">Round <span id="currentRound">—</span> / <span id="totalRounds">—</span></p>
<p id="votesStatus" class="waiting">En attente du lancement...</p>
<table class="score-table">
<thead><tr><th>Nom</th><th>Points Round</th><th>Total</th></tr></thead>
<tbody id="resultsTable"></tbody>
</table>
<div class="chart-container">
<canvas id="scoresChart"></canvas>
</div>
<button id="roundControlBtn" class="roundBtn" disabled>Lancer Round</button>
</div>

<div class="card">
<h1>Configuration du Jeu</h1>
<label>Joueurs (pair)</label>
<select id="numPlayers">
<option value="2">2</option>
<option value="4">4</option>
<option value="6">6</option>
<option value="8">8</option>
<option value="10">10</option>
</select>
<label>Rounds</label>
<select id="numRounds"><script>for(let i=10;i<=50;i+=5)document.write(`<option value="${i}">${i}</option>`);</script></select>
<div class="btn-group">
<button onclick="saveConfig()">Configurer</button>
<button class="reset" onclick="resetAll()">Réinitialiser</button>
</div>
<p id="status" style="text-align:center; margin-top:1rem;">En attente de configuration...</p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBREaX2qwor0mO6Q4xAVOVERuQmYYeKWfw",
  authDomain: "jeu-prisonnier.firebaseapp.com",
  databaseURL: "https://jeu-prisonnier-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jeu-prisonnier",
  storageBucket: "jeu-prisonnier.firebasestorage.app",
  messagingSenderId: "165842620681",
  appId: "1:165842620681:web:0f57a9d473810031ba83d8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const payoffs = { 'CC':3,'CD':0,'DC':5,'DD':1 };
let scoresChart=null;

async function saveConfig(){
  const players=parseInt(document.getElementById('numPlayers').value);
  const rounds=parseInt(document.getElementById('numRounds').value);
  if(players%2!==0) return alert("Nombre de joueurs doit être pair !");
  const ids=Array.from({length:players},(_,i)=>i+1);
  for(let i=ids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ids[i],ids[j]]=[ids[j],ids[i]]; }
  const paires={}; for(let i=0;i<ids.length;i+=2){ paires[ids[i]]=ids[i+1]; paires[ids[i+1]]=ids[i]; }

  const newState={round:1, scores:{}, paires, names:{}, votes:{}, roundStarted:false};
  for(let i=1;i<=players;i++) newState.scores[i]={total:0, round:0};

  await db.ref('config').set({players,rounds});
  await db.ref('game').set(newState);

  document.getElementById('roundControlBtn').disabled=false;
  document.getElementById('status').innerHTML=`<strong style="color:#9b59b6">Configuration OK.</strong>`;
}

// Lancer / passer round
document.getElementById('roundControlBtn').addEventListener('click', async ()=>{
  const snap = await db.ref('game').once('value'); const state = snap.val();
  if(!state) return;
  if(!state.roundStarted){ // Lancer round
    await db.ref('game').update({roundStarted:true,votes:{}});
  } else { // Passer round
    // Calcul scores
    const votes = state.votes || {}; const paires = state.paires;
    for(let i=1;i<=Object.keys(paires).length;i++){
      const m = votes[i]; if(!m) continue;
      const a = paires[i]; const ac = votes[a]||'—';
      const p = payoffs[m+ac]||0;
      await db.ref(`game/scores/${i}/round`).set(p);
      await db.ref(`game/scores/${i}/total`).transaction(t=>(t||0)+p);
    }
    if(state.round>=document.getElementById('numRounds').value){
      document.getElementById('roundControlBtn').disabled=true;
      document.getElementById('roundControlBtn').innerText="Fin";
      alert("Jeu terminé !");
      return;
    }
    await db.ref('game').update({round:state.round+1,roundStarted:true,votes:{}});
  }
});

// Affichage
db.ref('config').on('value', configSnap=>{
  db.ref('game').on('value', gameSnap=>{
    const config=configSnap.val()||{}; const state=gameSnap.val()||{};
    document.getElementById('currentRound').innerText=state.round||1;
    document.getElementById('totalRounds').innerText=config.rounds||0;

    const tbody=document.getElementById('resultsTable'); tbody.innerHTML='';
    let votesCount=0;
    for(let i=1;i<=config.players;i++){
      const s=state.scores?.[i]||{round:0,total:0};
      const name=state.names?.[i]||`Joueur ${i}`;
      if(state.votes?.[i]) votesCount++;
      tbody.innerHTML+=`<tr><td><strong>${name}</strong></td><td><strong>${s.round}</strong></td><td><strong>${s.total}</strong></td></tr>`;
    }

    const btn=document.getElementById('roundControlBtn');
    if(state.round>=config.rounds){ btn.innerText="Fin"; btn.disabled=true; }
    else if(!state.roundStarted){ btn.innerText="Lancer Round"; btn.disabled=false; }
    else { btn.innerText="Passer au round suivant"; btn.disabled=votesCount<config.players; }

    document.getElementById('votesStatus').innerText=state.roundStarted
      ? `${votesCount}/${config.players} votes`
      : "En attente du lancement";

    updateScoresChart(state,config.players);
  });
});

function resetAll(){
  if(!confirm("Tout sera effacé.")) return;
  db.ref('config').set({});
  db.ref('game').set({round:1,scores:{},paires:{},names:{},votes:{},roundStarted:false});
  document.getElementById('status').innerHTML=`<strong style="color:#e74c3c">Réinitialisé !</strong>`;
  document.getElementById('roundControlBtn').innerText="Lancer Round";
  document.getElementById('roundControlBtn').disabled=true;
  if(scoresChart) scoresChart.destroy();
}

let scoresChart=null;
function updateScoresChart(state,numPlayers){
  const ctx=document.getElementById('scoresChart').getContext('2d');
  const labels=[]; const data=[]; const colors=['#4a90e2','#2ecc71','#f39c12','#e74c3c','#9b59b6','#1abc9c','#34495e','#e67e22','#27ae60','#8e44ad'];
  for(let i=1;i<=numPlayers;i++){ labels.push(state.names?.[i]||`Joueur ${i}`); data.push(state.scores?.[i]?.total||0); }
  const config={type:'bar',data:{labels,datasets:[{data,backgroundColor:colors.slice(0,numPlayers),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:800},plugins:{legend:{display:false},title:{display:true,text:'Scores Totaux',color:'#0f0f1a'}},scales:{y:{beginAtZero:true,ticks:{color:'#0f0f1a'}},x:{ticks:{color:'#0f0f1a'}}}}};
  if(scoresChart) scoresChart.destroy();
  scoresChart=new Chart(ctx,config);
}
</script>
</body>
</html>
