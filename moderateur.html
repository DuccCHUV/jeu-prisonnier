<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Modérateur - Prisonnier</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root {
  --bg: #0f0f1a; --card: rgba(255,255,255,0.95); --accent: #4a90e2; --text: #1a1a2e;
  --green: #2ecc71; --red: #e74c3c; --orange: #f39c12;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  background: url('image.jpg') center/cover no-repeat fixed; 
  font-family: 'Segoe UI', sans-serif; color: var(--text); 
  display:flex; flex-direction:column; align-items:center; gap:2rem; padding:2rem; min-height:100vh;
}
.card { 
  background: var(--card); border-radius:16px; padding:2rem; box-shadow:0 8px 24px rgba(0,0,0,0.1); 
  width:90%; max-width:900px; border:1px solid rgba(74,144,226,0.2);
}
h1 { text-align:center; margin-bottom:1rem; }
select, button { width:100%; padding:0.9rem; border-radius:8px; border:none; margin-bottom:1rem; font-size:1rem;}
select { background:#333; color:white; }
button { background: var(--accent); color:white; font-weight:bold; cursor:pointer; transition:0.2s;}
button:hover:not(:disabled){ background:#357abd; transform:scale(1.02);}
button:disabled{ opacity:0.5; cursor:not-allowed;}
button.roundBtn{ background: var(--green); font-size:1.2rem; padding:1.2rem; margin-top:1.5rem;}
.score-table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:1rem;}
.score-table th, .score-table td{ padding:0.8rem; text-align:center; border-bottom:1px solid #444;}
.score-table th { background:#222; }
.chart-container{ background: rgba(26,26,46,0.95); border-radius:12px; padding:1rem; height:380px; margin-top:1.5rem; }
.waiting { color: var(--orange); font-weight:bold; text-align:center; margin-top:0.5rem; }
.btn-group { display:flex; gap:1rem; margin-top:1rem; }
.btn-group button{ flex:1; }
.btn-group button.reset { background: var(--red); }
.btn-group button.reset:hover{ background:#c0392b; }
</style>
</head>
<body>

<div class="card">
  <h1>Scores en Direct <span class="live">Live</span></h1>
  <p style="text-align:center;">Round <span id="currentRound">—</span> / <span id="totalRounds">—</span></p>
  <p id="votesStatus" class="waiting">En attente du lancement...</p>
  <table class="score-table">
    <thead><tr><th>Nom</th><th>Points Round</th><th>Total</th></tr></thead>
    <tbody id="resultsTable"></tbody>
  </table>
  <div class="chart-container"><canvas id="scoresChart"></canvas></div>
  <button id="roundControlBtn" class="roundBtn" disabled>Lancer Round</button>
</div>

<div class="card">
  <h1>Configuration du Jeu</h1>
  <label>Joueurs (pair)</label>
  <select id="numPlayers"><option value="2">2</option><option value="4">4</option><option value="6">6</option><option value="8">8</option><option value="10">10</option></select>
  <label>Rounds</label>
  <select id="numRounds"><script>for(let i=10;i<=50;i+=5)document.write(`<option value="${i}">${i}</option>`);</script></select>
  <div class="btn-group">
    <button onclick="saveConfig()">Configurer</button>
    <button class="reset" onclick="resetAll()">Réinitialiser</button>
  </div>
  <p id="status" style="text-align:center; margin-top:1rem;">En attente de configuration...</p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBREaX2qwor0mO6Q4xAVOVERuQmYYeKWfw",
  authDomain: "jeu-prisonnier.firebaseapp.com",
  databaseURL: "https://jeu-prisonnier-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jeu-prisonnier",
  storageBucket: "jeu-prisonnier.firebasedapp.com",
  messagingSenderId: "165842620681",
  appId: "1:165842620681:web:0f57a9d473810031ba83d8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const payoffs = { 'CC':3,'CD':0,'DC':5,'DD':1 };
let scoresChart = null;

// ================== Configuration ==================
function saveConfig(){
  const players = parseInt(document.getElementById('numPlayers').value);
  const rounds = parseInt(document.getElementById('numRounds').value);
  if(players%2!==0) return alert("Nombre de joueurs doit être pair !");

  const ids=Array.from({length:players},(_,i)=>i+1);
  for(let i=ids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ids[i],ids[j]]=[ids[j],ids[i]]; }
  const paires={};
  for(let i=0;i<ids.length;i+=2){ paires[ids[i]]=ids[i+1]; paires[ids[i+1]]=ids[i]; }

  const newState={ round:1, scores:{}, paires, names:{}, usedIds:[], votes:{}, roundStarted:false };
  for(let i=1;i<=players;i++) newState.scores[i]={total:0, round:0};

  db.ref('config').set({players, rounds});
  db.ref('state').set(newState).then(()=>{
    document.getElementById('status').innerHTML=`<strong style="color:#9b59b6">Configuration OK.</strong>`;
    document.getElementById('roundControlBtn').disabled=false;
  });
}

// ================== Round ==================
document.getElementById('roundControlBtn').addEventListener('click', async ()=>{
  const snap = await db.ref('state').once('value');
  const state = snap.val();
  if(!state) return;

  if(!state.roundStarted){
    db.ref('state').update({ roundStarted:true, votes:{} });
    return;
  }

  // Calcul des points
  const configSnap = await db.ref('config').once('value');
  const config = configSnap.val() || {};
  for(let i=1;i<=config.players;i++){
    const m=state.votes?.[i]; if(!m) continue;
    const a=state.paires[i]; const ac=state.votes?.[a]||'—';
    const p=payoffs[m+ac]||0;
    db.ref(`state/scores/${i}/round`).set(p);
    db.ref(`state/scores/${i}/total`).transaction(t=>(t||0)+p);
  }

  if(state.round >= config.rounds){
    document.getElementById('roundControlBtn').innerText="Fin";
    document.getElementById('roundControlBtn').disabled=true;
    alert("Jeu terminé !");
    return;
  }

  db.ref('state').update({ round: state.round +1, votes:{}, roundStarted:true });
});

// ================== Reset ==================
function resetAll(){
  if(!confirm("Tout sera effacé.")) return;
  db.ref().set({config:{}, state:{ round:1, scores:{}, paires:{}, names:{}, usedIds:[], votes:{}, roundStarted:false}});
  document.getElementById('resultsTable').innerHTML='';
  document.getElementById('roundControlBtn').innerText='Lancer Round';
  document.getElementById('roundControlBtn').disabled=true;
  if(scoresChart) scoresChart.destroy();
}

// ================== Affichage en temps réel ==================
db.ref('state').on('value', stateSnap=>{
  db.ref('config').once('value').then(configSnap=>{
    const state = stateSnap.val() || {};
    const config = configSnap.val() || {};
    if(!config.players) return;

    document.getElementById('currentRound').innerText = state.round || 1;
    document.getElementById('totalRounds').innerText = config.rounds;

    const tbody = document.getElementById('resultsTable');
    tbody.innerHTML='';
    let votesCount=0;
    for(let i=1;i<=config.players;i++){
      if(state.votes?.[i]) votesCount++;
      const s = state.scores?.[i] || { round:0, total:0 };
      const name = state.names?.[i] || `Joueur ${i}`;
      tbody.innerHTML += `<tr><td><strong>${name}</strong></td><td><strong>${s.round}</strong></td><td><strong>${s.total}</strong></td></tr>`;
    }

    const btn = document.getElementById('roundControlBtn');
    if(state.round >= config.rounds){ btn.innerText="Fin"; btn.disabled=true; }
    else if(!state.roundStarted){ btn.innerText="Lancer Round"; btn.disabled=false; }
    else{ btn.innerText="Passer au round suivant"; btn.disabled = votesCount < config.players; }

    document.getElementById('votesStatus').innerText = state.roundStarted
      ? `${votesCount}/${config.players} votes`
      : "En attente du lancement";

    updateScoresChart(state, config.players);
  });
});

// ================== Graphique ==================
function updateScoresChart(state, numPlayers){
  const ctx = document.getElementById('scoresChart').getContext('2d');
  const labels=[], data=[];
  const colors=['#4a90e2','#2ecc71','#f39c12','#e74c3c','#9b59b6','#1abc9c','#34495e','#e67e22','#27ae60','#8e44ad'];
  for(let i=1;i<=numPlayers;i++){
    labels.push(state.names?.[i]||`Joueur ${i}`);
    data.push(state.scores?.[i]?.total||0);
  }
  const configChart = {
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor:colors.slice(0,numPlayers), borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, title:{display:true,text:'Scores Totaux', color:'#1a1a2e', font:{size:16}} },
      scales:{ y:{beginAtZero:true,ticks:{color:'#1a1a2e'}}, x:{ticks:{color:'#1a1a2e'}} }
    }
  };
  if(scoresChart) scoresChart.destroy();
  scoresChart = new Chart(ctx, configChart);
}

</script>
</body>
</html>
