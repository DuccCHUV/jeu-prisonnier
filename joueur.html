<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Joueur - Dilemme du prisonnier</title>

  <!-- CSS EXTERNE -->
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="joueur-body">

  <div class="card joueur-card">
    <!-- Page d'inscription -->
    <div id="setupPage">
      <h1>Choisissez NOM + ID</h1>
      <input id="playerName" placeholder="Votre nom (ex: Alice)" />
      <input id="playerIdInput" type="number" min="1" max="20" placeholder="ID (1-20)" />
      <button onclick="savePlayer()">Confirmer</button>
    </div>

    <!-- Page de jeu -->
    <div id="gamePage" class="hidden">
      <h1><span id="displayName">?</span> (ID <span id="displayId">?</span>)</h1>
      <p>Round <span id="currentRound">1</span> / <span id="totalRounds">?</span></p>
      <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
      <p id="roundStatus" class="locked">En attente du modérateur...</p>
      <div style="display: flex; justify-content: center; gap: 1rem; margin: 1.5rem 0;">
        <button id="btnCoop" class="choice-btn coop" onclick="vote('C')" disabled>Coopérer</button>
        <button id="btnTrahir" class="choice-btn trahir" onclick="vote('D')" disabled>Trahir</button>
      </div>
    </div>
  </div>

  <script>
    // --- Configuration Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBREaX2qwor0mO6Q4xAVOVERuQmYYeKWfw",
      authDomain: "jeu-prisonnier.firebaseapp.com",
      databaseURL: "https://jeu-prisonnier-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "jeu-prisonnier",
      storageBucket: "jeu-prisonnier.firebasestorage.app",
      messagingSenderId: "165842620681",
      appId: "1:165842620681:web:0f57a9d473810031ba83d8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Variables globales ---
    let playerName = null;
    let playerId = null;

    // --- Sauvegarde joueur ---
    function savePlayer() {
      playerName = document.getElementById('playerName').value.trim();
      playerId = parseInt(document.getElementById('playerIdInput').value);
      if (!playerName || !playerId || playerId < 1 || playerId > 20)
        return alert("Nom + ID (1-20) requis !");
      localStorage.setItem('playerData', JSON.stringify({ name: playerName, id: playerId }));
      
      db.ref(`game/names/${playerId}`).set(playerName);
      showGame();
    }

    // --- Chargement joueur ---
    function loadPlayer() {
      const saved = localStorage.getItem('playerData');
      if (saved) {
        const data = JSON.parse(saved);
        playerName = data.name;
        playerId = data.id;
        showGame();
      }
    }

    // --- Affiche la page de jeu ---
    function showGame() {
      document.getElementById('setupPage').classList.add('hidden');
      document.getElementById('gamePage').classList.remove('hidden');
      document.getElementById('displayName').innerText = playerName;
      document.getElementById('displayId').innerText = playerId;
      loadGameState();
    }

    // --- Écoute les changements Firebase ---
    function loadGameState() {
      const configRef = db.ref('config');
      const gameRef = db.ref('game');
      let configSnap = null;

      configRef.on('value', snap => {
        configSnap = snap;
        const config = snap.val() || {};

        // === SI LE JEU EST RÉINITIALISÉ ===
        if (!config.players || !config.rounds) {
          localStorage.removeItem('playerData');
          document.getElementById('setupPage').classList.remove('hidden');
          document.getElementById('gamePage').classList.add('hidden');
          return;
        }

        document.getElementById('totalRounds').innerText = config.rounds || '?';
      });

      gameRef.on('value', gameSnap => {
        if (!playerId) return;
        const game = gameSnap.val() || {};
        const round = game.currentRound || game.round || 1;
        const active = game.roundActive === true;
        const votes = game.votes || {};

        document.getElementById('currentRound').innerText = round;
        updateProgress(round, configSnap?.val()?.rounds || 10);

        const hasVoted = !!votes[playerId];
        const isLocked = !active;

        document.getElementById('btnCoop').disabled = isLocked || hasVoted;
        document.getElementById('btnTrahir').disabled = isLocked || hasVoted;

        document.getElementById('roundStatus').innerText = !active
          ? "En attente du modérateur..."
          : hasVoted ? "Vote enregistré !" : "Votre tour !";
      });
    }

    // --- Voter ---
    function vote(choice) {
      db.ref(`game/votes/${playerId}`).set(choice);
    }

    // --- Barre de progression ---
    function updateProgress(current, total) {
      if (!total) return;
      const p = ((current - 1) / total) * 100;
      document.getElementById('progressBar').style.width = p + '%';
    }

    // --- Chargement au démarrage ---
    window.onload = () => {
      db.ref('config').once('value').then(snap => {
        const config = snap.val();
        if (!config || !config.players) {
          localStorage.removeItem('playerData');
        } else {
          loadPlayer();
        }
      });
    };
  </script>
</body>
</html>
